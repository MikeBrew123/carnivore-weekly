<!-- Related Content Component -->
<!-- Drop this into wiki sections, blog posts, or video cards -->
<!-- Agent will populate data-content-type and data-content-id -->

<section class="related-content" data-content-type="blog" data-content-id="pcos-hormones">
    <h3 class="related-content-title">Related Content</h3>
    <div class="related-content-loading">
        <span class="spinner"></span>
        Loading related content...
    </div>
    <div class="related-content-grid" style="display: none;">
        <!-- Populated by JavaScript -->
    </div>
</section>

<style>
.related-content {
    margin: 3rem 0;
    padding: 2rem;
    background: var(--color-cream, #f5f5f0);
    border-radius: 8px;
    border-left: 4px solid var(--color-amber, #ffbf00);
}

.related-content-title {
    font-family: var(--font-heading, 'Playfair Display', serif);
    font-size: 1.5rem;
    color: var(--color-oxblood, #4a0404);
    margin: 0 0 1.5rem 0;
}

.related-content-loading {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    color: var(--color-text-secondary, #4a4a4a);
    font-size: 0.95rem;
}

.spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid var(--color-border, #e0e0e0);
    border-top-color: var(--color-amber, #ffbf00);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.related-content-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
}

.related-content-card {
    background: var(--color-white, #ffffff);
    border: 1px solid var(--color-border, #e0e0e0);
    border-radius: 6px;
    padding: 1.25rem;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    text-decoration: none;
    color: inherit;
    display: block;
}

.related-content-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.related-content-type {
    display: inline-block;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 0.25rem 0.5rem;
    border-radius: 3px;
    margin-bottom: 0.75rem;
}

.related-content-type--wiki {
    background: #e8f5e9;
    color: #2d5016;
}

.related-content-type--blog {
    background: #fff3e0;
    color: #8b4513;
}

.related-content-type--video {
    background: #fce4ec;
    color: #c2185b;
}

.related-content-card h4 {
    font-family: var(--font-heading, 'Playfair Display', serif);
    font-size: 1.125rem;
    color: var(--color-charcoal, #1a1a1a);
    margin: 0 0 0.5rem 0;
    line-height: 1.4;
}

.related-content-topic {
    font-size: 0.85rem;
    color: var(--color-text-muted, #6b6b6b);
    font-style: italic;
}

.related-content-empty {
    color: var(--color-text-secondary, #4a4a4a);
    font-style: italic;
    text-align: center;
    padding: 2rem 0;
}

@media (max-width: 768px) {
    .related-content {
        padding: 1.5rem;
    }

    .related-content-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
(function() {
    'use strict';

    // Supabase connection
    const SUPABASE_URL = 'https://kwtdpvnjewtahuxjyltn.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt3dGRwdm5qZXd0YWh1eGp5bHRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU2NTMwODMsImV4cCI6MjA1MTIyOTA4M30.xHKnN93F5cC4CSLZ4gQEIa0Gn_MvPYdaC-1HhL7Ayzc';

    // Content title mappings (for display)
    const CONTENT_TITLES = {
        wiki: {
            'cholesterol': 'Cholesterol Myths',
            'weight-stall': 'Weight Loss Stalls',
            'fiber': 'Fiber Necessity',
            'keto-to-carnivore': 'Keto to Carnivore',
            'dairy': 'Dairy on Carnivore',
            'electrolytes': 'Electrolyte Balance',
            'organ-meats': 'Organ Meat Guide',
            'digestion': 'Digestive Adaptation',
            'salt': 'Salt Recommendations'
        },
        blog: {
            'pcos-hormones': 'PCOS & Carnivore Diet',
            'beginners-blueprint': 'Beginner\'s Blueprint',
            'organ-meats-guide': 'Organ Meats Deep Dive',
            'night-sweats': 'Night Sweats During Adaptation',
            'mtor-muscle': 'mTOR & Muscle Growth'
        }
    };

    // Initialize all related content sections
    async function initRelatedContent() {
        const sections = document.querySelectorAll('.related-content');

        for (const section of sections) {
            const contentType = section.dataset.contentType;
            const contentId = section.dataset.contentId;

            if (!contentType || !contentId) {
                console.warn('Related content section missing data attributes');
                continue;
            }

            try {
                const relatedItems = await fetchRelatedContent(contentType, contentId);
                renderRelatedContent(section, relatedItems);
            } catch (error) {
                console.error('Failed to load related content:', error);
                showError(section);
            }
        }
    }

    // Fetch related content from Supabase
    async function fetchRelatedContent(contentType, contentId) {
        const response = await fetch(
            `${SUPABASE_URL}/rest/v1/rpc/get_related_content`,
            {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                },
                body: JSON.stringify({
                    p_content_type: contentType,
                    p_content_identifier: contentId,
                    p_limit: 6
                })
            }
        );

        if (!response.ok) {
            // Fallback: use view directly
            return fetchViaView(contentType, contentId);
        }

        return response.json();
    }

    // Fallback: query view directly
    async function fetchViaView(contentType, contentId) {
        const response = await fetch(
            `${SUPABASE_URL}/rest/v1/v_related_content?source_type=eq.${contentType}&source_identifier=eq.${contentId}&limit=6`,
            {
                headers: {
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                }
            }
        );

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();

        // Deduplicate by content identifier
        const seen = new Set();
        return data.filter(item => {
            const key = `${item.related_type}-${item.related_identifier}`;
            if (seen.has(key)) return false;
            seen.add(key);
            return true;
        });
    }

    // Render related content cards
    function renderRelatedContent(section, items) {
        const loading = section.querySelector('.related-content-loading');
        const grid = section.querySelector('.related-content-grid');

        loading.style.display = 'none';
        grid.style.display = 'grid';

        if (items.length === 0) {
            grid.innerHTML = '<p class="related-content-empty">No related content found yet. Check back soon!</p>';
            return;
        }

        grid.innerHTML = items.map(item => createCard(item)).join('');
    }

    // Create HTML card for related content
    function createCard(item) {
        const type = item.related_type;
        const id = item.related_identifier;
        const topic = item.shared_topic_name || 'Related';

        // Get title
        let title = CONTENT_TITLES[type]?.[id] || formatTitle(id);

        // Get URL
        let url;
        if (type === 'wiki') {
            url = `/wiki.html#${id}`;
        } else if (type === 'blog') {
            url = `/blog/${findBlogFile(id)}`;
        } else if (type === 'video') {
            url = `/channels.html?v=${id}`;
        }

        return `
            <a href="${url}" class="related-content-card">
                <span class="related-content-type related-content-type--${type}">${type}</span>
                <h4>${title}</h4>
                <p class="related-content-topic">Via: ${topic}</p>
            </a>
        `;
    }

    // Format identifier as title (fallback)
    function formatTitle(slug) {
        return slug
            .split('-')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
            .join(' ');
    }

    // Find blog file with date prefix
    function findBlogFile(slug) {
        // This is a simplified version - in production, fetch from manifest
        return `2025-12-30-${slug}.html`;
    }

    // Show error state
    function showError(section) {
        const loading = section.querySelector('.related-content-loading');
        const grid = section.querySelector('.related-content-grid');

        loading.style.display = 'none';
        grid.style.display = 'block';
        grid.innerHTML = '<p class="related-content-empty">Unable to load related content. Please refresh the page.</p>';
    }

    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initRelatedContent);
    } else {
        initRelatedContent();
    }
})();
</script>
