╔══════════════════════════════════════════════════════════════════════════════╗
║                    DATABASE UNBLOCK - QUICK START GUIDE                     ║
║                                                                              ║
║ Status: Database schema missing (calculator_sessions_v2)                    ║
║ Error:  DB_INSERT_FAILED when creating session                             ║
║ Fix:    Apply SQL migrations to Supabase (5 minutes)                        ║
╚══════════════════════════════════════════════════════════════════════════════╝


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1. OPEN SUPABASE SQL EDITOR
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Click this link:
https://supabase.com/dashboard/project/kwtdpvnjewtahuxjyltn/sql/new

You'll see a blank SQL editor.


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
2. RUN MIGRATION 1: CREATE SCHEMA (COPY & PASTE)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

File to copy: SUPABASE_MIGRATION_COMBINED.sql

Steps:
  1. Open that file in your editor
  2. Select ALL (Cmd+A or Ctrl+A)
  3. Copy (Cmd+C or Ctrl+C)
  4. Paste into Supabase editor (Cmd+V or Ctrl+V)
  5. Click "Execute" button
  6. Wait for green checkmark ✓

This creates:
  ✓ payment_tiers table
  ✓ calculator_sessions_v2 table
  ✓ calculator_reports table
  ✓ calculator_report_access_log table
  ✓ claude_api_logs table
  ✓ validation_errors table
  ✓ All indexes and RLS policies
  ✓ All triggers


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
3. RUN MIGRATION 2: SEED PAYMENT TIERS (COPY & PASTE)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

File to copy: SUPABASE_SEED_PAYMENT_TIERS.sql

Steps:
  1. Click "New query" button (top left)
  2. Open that file in your editor
  3. Select ALL (Cmd+A or Ctrl+A)
  4. Copy (Cmd+C or Ctrl+C)
  5. Paste into NEW Supabase editor tab (Cmd+V or Ctrl+V)
  6. Click "Execute" button
  7. Wait for green checkmark ✓

This creates:
  ✓ Starter tier ($29.99)
  ✓ Pro tier ($99.99)
  ✓ Elite tier ($199.99)
  ✓ Lifetime tier ($499.99)


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
4. VERIFY IT WORKED
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

In Supabase SQL editor, run this:

  SELECT COUNT(*) FROM payment_tiers;

Expected result: 4

If you see 4, you're done! ✓


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
5. TEST THE API
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Make sure wrangler is running:
  cd api
  wrangler dev --port 8787

In a NEW terminal, run:
  curl -X POST http://localhost:8787/api/v1/calculator/session \
    -H "Content-Type: application/json" \
    -d '{}'

Expected: HTTP 201 with session_token

Example response:
  {
    "session_token": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
    "session_id": "550e8400-e29b-41d4-a716-446655440000",
    "created_at": "2026-01-03T20:30:00.000Z"
  }


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
6. TEST THE FULL FLOW (Optional)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Run the integration test:
  bash TEST_CALCULATOR_API.sh

All tests should PASS ✓


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
TIMELINE
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Step 1: Open editor          1 minute
Step 2: Run migration 1      2 minutes
Step 3: Run migration 2      1 minute
Step 4: Verify              1 minute
Step 5: Test API            1 minute
Step 6: Test full flow      3 minutes
                           ────────────
TOTAL:                      9 minutes


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
WHAT GETS CREATED
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Tables:
  • payment_tiers - 4 subscription options
  • calculator_sessions_v2 - Complete user journey tracking
  • calculator_reports - AI-generated reports
  • calculator_report_access_log - Access audit trail
  • claude_api_logs - API request tracking
  • validation_errors - Field validation logs

Features:
  • ACID compliance (data integrity guaranteed)
  • 20+ CHECK constraints (prevent invalid data)
  • Row-Level Security (RLS) policies
  • Cryptographic access tokens
  • Automatic timestamps
  • Performance indexes


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
IF SOMETHING GOES WRONG
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Error: "Could not find the table"
→ Migration didn't run. Re-run Step 2.

Error: "permission denied"
→ Service role key not set. Run:
  cd api
  wrangler secret put SUPABASE_SERVICE_ROLE_KEY
  # Paste: sb_secret_-DJISSDQQD7oWqS87RBJ8Q_0sKdDWVz

Error: "HTTP 500"
→ Database or credentials issue. Check:
  1. Both migrations ran (verify in Step 4)
  2. Secrets are set (see above)
  3. Restart wrangler dev

Error: "duplicate key on tier_slug"
→ Tiers already exist. This is OK. Skip this error.


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
FILES AVAILABLE
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

SUPABASE_MIGRATION_COMBINED.sql      Main schema (copy & paste)
SUPABASE_SEED_PAYMENT_TIERS.sql      Pricing tiers (copy & paste)
EXECUTION_CHECKLIST.md               Step-by-step checklist
DATABASE_UNBLOCK_STEPS.md            Detailed documentation
TEST_CALCULATOR_API.sh               Integration test suite
VERIFY_WRANGLER_SETUP.sh             Environment verification
UNBLOCK_SUMMARY.txt                  Executive summary


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
SUCCESS LOOKS LIKE
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✓ Payment tiers query returns 4 rows
✓ API session endpoint returns 201 Created
✓ Test suite passes all 5 endpoints
✓ No 500 errors in logs
✓ Frontend form loads without errors
✓ Ready for payment testing


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
NEXT STEPS AFTER UNBLOCK
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. Test Stripe integration
2. Test Claude API report generation
3. Deploy to production
4. Configure email notifications
5. Monitor analytics


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

"A database is a promise you make to the future. Don't break it."

Last updated: 2026-01-03
Status: READY FOR DEPLOYMENT

Let's go!
