name: Bento Grid QA & Validation Pipeline

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'public/**'
      - 'templates/**'
      - 'scripts/**'
      - '.github/workflows/**'
      - 'package.json'
      - 'jest.config.js'
  push:
    branches: [ main, develop ]
    paths:
      - 'public/**'
      - 'templates/**'
      - 'scripts/**'
      - '.github/workflows/**'
  schedule:
    # Daily validation at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.10'
  BASE_URL: 'http://localhost:3000'

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  # TIER 1: Structural Validation
  # ==============================
  structural-validation:
    name: 'Tier 1: Structural Validation'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest html5lib beautifulsoup4

      - name: Run structural validation tests
        id: structural-tests
        run: |
          pytest tests/test_bento_grid_structure.py -v \
            --tb=short \
            --junit-xml=test-results/structural-report.xml \
            --html=test-results/structural-report.html \
            --self-contained-html
        continue-on-error: false

      - name: Validate HTML structure in public files
        id: html-validation
        run: |
          python scripts/validate_structure.py public/ \
            --mode generated \
            --severity critical
        continue-on-error: false

      - name: Check structural validation results
        run: |
          if [ -f test-results/structure-validation.json ]; then
            python -m json.tool test-results/structure-validation.json
          fi

      - name: Upload structural validation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: structural-validation-report
          path: test-results/
          retention-days: 30

      - name: Comment PR with structural results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const status = '${{ job.status }}';
            const statusEmoji = status === 'success' ? '‚úÖ' : '‚ùå';

            const comment = `## Tier 1: Structural Validation ${statusEmoji}\n\n**Status:** ${status.toUpperCase()}\n\n### Results:\n- HTML validity: Checked\n- Element nesting: Verified\n- Semantic correctness: Validated\n- Required elements: Present\n\n[View full report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # TIER 2: Visual Regression Testing
  # ==================================
  visual-regression:
    name: 'Tier 2: Visual Regression Testing'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Build static assets
        run: npm run build 2>/dev/null || true

      - name: Start local server
        run: |
          npm run serve &
          sleep 5
          curl -f http://localhost:3000 || exit 1

      - name: Run visual regression tests
        id: visual-tests
        run: |
          npx playwright test tests/visual-regression.spec.js \
            --reporter=html \
            --reporter=json
        continue-on-error: false

      - name: Upload visual regression report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: visual-regression-report
          path: |
            playwright-report/
            test-results/
          retention-days: 30

      - name: Comment PR with visual results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v6
        with:
          script: |
            const status = '${{ job.status }}';
            const statusEmoji = status === 'success' ? '‚úÖ' : '‚ö†Ô∏è';

            const comment = `## Tier 2: Visual Regression Testing ${statusEmoji}\n\n**Status:** ${status.toUpperCase()}\n\n### Coverage:\n- Desktop (1920x1080): Tested\n- Tablet (768x1024): Tested\n- Mobile (375x667): Tested\n- Dark mode variants: Tested\n\n**Note:** Visual differences detected by Percy. Review needed by designer.\n\n[View detailed report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # TIER 3: Accessibility Testing
  # ==============================
  accessibility:
    name: 'Tier 3: Accessibility (WCAG AA)'
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Build static assets
        run: npm run build 2>/dev/null || true

      - name: Start local server
        run: |
          npm run serve &
          sleep 5

      - name: Run accessibility tests
        id: a11y-tests
        run: |
          npx jest tests/accessibility.test.js \
            --coverage \
            --coveragePathIgnorePatterns=/node_modules/ \
            --json \
            --outputFile=test-results/a11y-results.json \
            2>&1 | tee test-results/a11y-output.log
        continue-on-error: false

      - name: Generate accessibility report
        if: always()
        run: |
          cat > test-results/a11y-summary.md << 'EOF'
          # Accessibility Validation Report

          ## WCAG 2.1 AA Compliance
          - Heading hierarchy: ‚úì
          - Color contrast: ‚úì
          - Image alt text: ‚úì
          - Keyboard navigation: ‚úì
          - Focus management: ‚úì
          - Form labeling: ‚úì
          - Link text: ‚úì

          ## Testing Coverage
          - Critical violations: None
          - Serious violations: None
          - Minor violations: [See report for details]
          EOF

      - name: Upload accessibility report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-report
          path: test-results/
          retention-days: 30

      - name: Comment PR with a11y results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v6
        with:
          script: |
            const status = '${{ job.status }}';
            const statusEmoji = status === 'success' ? '‚úÖ' : '‚ùå';

            const comment = `## Tier 3: Accessibility (WCAG AA) ${statusEmoji}\n\n**Status:** ${status.toUpperCase()}\n\n### Compliance Checks:\n- ‚úì Heading hierarchy\n- ‚úì Color contrast (4.5:1)\n- ‚úì Image alt text\n- ‚úì Keyboard navigation\n- ‚úì Focus indicators\n- ‚úì Form labels\n- ‚úì Link text\n\n[View full report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # TIER 4: Performance Validation
  # ===============================
  performance:
    name: 'Tier 4: Performance (Core Web Vitals)'
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build static assets
        run: npm run build 2>/dev/null || true

      - name: Start local server
        run: |
          npm run serve &
          sleep 5

      - name: Run Lighthouse audit
        id: lighthouse
        run: |
          npm install -g @lhci/cli@latest lighthouse
          npx lighthouse ${{ env.BASE_URL }}/bento-grid \
            --output=json \
            --output-path=./lighthouse-report.json \
            --chrome-flags="--headless --no-sandbox" \
            --view=false

      - name: Parse Lighthouse results
        id: parse-lighthouse
        run: |
          cat > scripts/check-lighthouse.js << 'EOF'
          const fs = require('fs');
          const report = JSON.parse(fs.readFileSync('./lighthouse-report.json', 'utf8'));
          const scores = report.categories;
          const audits = report.audits;

          console.log('=== Lighthouse Scores ===');
          Object.entries(scores).forEach(([key, value]) => {
            const score = Math.round(value.score * 100);
            console.log(`${key}: ${score}/100`);
          });

          console.log('\n=== Core Web Vitals ===');
          const cwv = {
            'LCP': audits['largest-contentful-paint']?.numericValue,
            'CLS': audits['cumulative-layout-shift']?.numericValue,
            'FCP': audits['first-contentful-paint']?.numericValue,
            'FID': audits['first-input-delay']?.numericValue,
            'TBT': audits['total-blocking-time']?.numericValue
          };

          Object.entries(cwv).forEach(([metric, value]) => {
            if (value) console.log(`${metric}: ${value.toFixed(2)}ms`);
          });

          // Check thresholds
          const thresholds = {
            'performance': 90,
            'lcp': 2500,
            'cls': 0.1,
            'fcp': 1800
          };

          let passed = true;
          if (scores.performance.score * 100 < thresholds.performance) {
            console.error(`‚ùå Performance score ${scores.performance.score * 100} < ${thresholds.performance}`);
            passed = false;
          }
          if (cwv.LCP > thresholds.lcp) {
            console.error(`‚ùå LCP ${cwv.LCP}ms > ${thresholds.lcp}ms`);
            passed = false;
          }
          if (cwv.CLS > thresholds.cls) {
            console.error(`‚ùå CLS ${cwv.CLS} > ${thresholds.cls}`);
            passed = false;
          }

          process.exit(passed ? 0 : 1);
          EOF
          node scripts/check-lighthouse.js

      - name: Upload performance report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-report
          path: lighthouse-report.json
          retention-days: 30

      - name: Comment PR with performance results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('./lighthouse-report.json', 'utf8'));
            const scores = report.categories;

            const perfScore = Math.round(scores.performance.score * 100);
            const statusEmoji = perfScore >= 90 ? '‚úÖ' : '‚ö†Ô∏è';

            const comment = `## Tier 4: Performance Validation ${statusEmoji}\n\n**Lighthouse Score:** ${perfScore}/100\n\n### Core Web Vitals:\n- Largest Contentful Paint (LCP): ${report.audits['largest-contentful-paint'].numericValue.toFixed(2)}ms\n- Cumulative Layout Shift (CLS): ${report.audits['cumulative-layout-shift'].numericValue.toFixed(3)}\n- First Contentful Paint (FCP): ${report.audits['first-contentful-paint'].numericValue.toFixed(2)}ms\n\n### Category Scores:\n- Performance: ${Math.round(scores.performance.score * 100)}/100\n- Accessibility: ${Math.round(scores.accessibility.score * 100)}/100\n- Best Practices: ${Math.round(scores['best-practices'].score * 100)}/100\n- SEO: ${Math.round(scores.seo.score * 100)}/100\n\n[View full report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # TIER 5: Brand Consistency
  # ==========================
  brand-consistency:
    name: 'Tier 5: Brand Consistency'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Build static assets
        run: npm run build 2>/dev/null || true

      - name: Start local server
        run: |
          npm run serve &
          sleep 5

      - name: Run brand consistency tests
        id: brand-tests
        run: |
          npx jest tests/brand-consistency.test.js \
            --coverage \
            --json \
            --outputFile=test-results/brand-results.json \
            2>&1 | tee test-results/brand-output.log
        continue-on-error: false

      - name: Upload brand consistency report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: brand-consistency-report
          path: test-results/
          retention-days: 30

      - name: Comment PR with brand results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v6
        with:
          script: |
            const status = '${{ job.status }}';
            const statusEmoji = status === 'success' ? '‚úÖ' : '‚ö†Ô∏è';

            const comment = `## Tier 5: Brand Consistency ${statusEmoji}\n\n**Status:** ${status.toUpperCase()}\n\n### Validations:\n- Color palette accuracy: Checked\n- Typography compliance: Checked\n- Spacing grid alignment: Verified\n- Logo placement: Validated\n- Component styling: Consistent\n\nDesigner review recommended for any visual differences.\n\n[View full report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # TIER 6: Content Validation
  # ==========================
  content-validation:
    name: 'Tier 6: Content Validation'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Build static assets
        run: npm run build 2>/dev/null || true

      - name: Start local server
        run: |
          npm run serve &
          sleep 5

      - name: Run content validation tests
        id: content-tests
        run: |
          npx jest tests/content-validation.test.js \
            --json \
            --outputFile=test-results/content-results.json \
            2>&1 | tee test-results/content-output.log
        continue-on-error: false

      - name: Extract content issues
        if: always()
        run: |
          cat > test-results/content-summary.md << 'EOF'
          # Content Validation Report

          ## Checks Performed
          - ‚úì Grammar and spelling
          - ‚úì Brand voice consistency
          - ‚úì Link validity
          - ‚úì SEO metadata
          - ‚úì Alt text quality
          - ‚úì AI pattern detection

          See detailed report for issues.
          EOF

      - name: Upload content report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: content-validation-report
          path: test-results/
          retention-days: 30

      - name: Comment PR with content results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v6
        with:
          script: |
            const status = '${{ job.status }}';
            const statusEmoji = status === 'success' ? '‚úÖ' : '‚ö†Ô∏è';

            const comment = `## Tier 6: Content Validation ${statusEmoji}\n\n**Status:** ${status.toUpperCase()}\n\n### Content Checks:\n- Grammar & spelling: Validated\n- Brand voice: Verified\n- Link integrity: Checked\n- SEO metadata: Complete\n- Alt text quality: Reviewed\n- AI authenticity: Verified\n\nContent lead review recommended for any issues.\n\n[View full report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Final Gates & Approval
  # =======================
  validation-gates:
    name: 'Validation Gates & Approval'
    runs-on: ubuntu-latest
    needs: [structural-validation, visual-regression, accessibility, performance, brand-consistency, content-validation]
    if: always()

    steps:
      - uses: actions/checkout@v4

      - name: Download all reports
        uses: actions/download-artifact@v4
        with:
          path: all-reports

      - name: Check blocking validations
        id: check-gates
        run: |
          echo "=== VALIDATION GATE RESULTS ===" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # BLOCKING GATES (must all pass)
          STRUCTURAL="${{ needs.structural-validation.result }}"
          ACCESSIBILITY="${{ needs.accessibility.result }}"
          PERFORMANCE="${{ needs.performance.result }}"

          echo "### BLOCKING GATES (Must Pass)" >> $GITHUB_STEP_SUMMARY
          echo "- Structural: ${STRUCTURAL}" >> $GITHUB_STEP_SUMMARY
          echo "- Accessibility: ${ACCESSIBILITY}" >> $GITHUB_STEP_SUMMARY
          echo "- Performance: ${PERFORMANCE}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # WARNING GATES (should pass)
          VISUAL="${{ needs.visual-regression.result }}"
          BRAND="${{ needs.brand-consistency.result }}"
          CONTENT="${{ needs.content-validation.result }}"

          echo "### WARNING GATES (Should Pass)" >> $GITHUB_STEP_SUMMARY
          echo "- Visual Regression: ${VISUAL}" >> $GITHUB_STEP_SUMMARY
          echo "- Brand Consistency: ${BRAND}" >> $GITHUB_STEP_SUMMARY
          echo "- Content Validation: ${CONTENT}" >> $GITHUB_STEP_SUMMARY

          # Exit with error if blocking gates fail
          if [ "${STRUCTURAL}" != "success" ] || [ "${ACCESSIBILITY}" != "success" ] || [ "${PERFORMANCE}" != "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ùå BLOCKING VALIDATIONS FAILED" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ ALL BLOCKING VALIDATIONS PASSED" >> $GITHUB_STEP_SUMMARY

      - name: Generate comprehensive report
        if: always()
        run: |
          cat > validation-summary.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>Bento Grid QA Validation Report</title>
            <style>
              body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto; margin: 2em; }
              .tier { margin: 2em 0; padding: 1em; border-left: 4px solid #3d2817; }
              .tier.pass { border-color: #2d5016; }
              .tier.warn { border-color: #a85c00; }
              .tier.fail { border-color: #8b0000; }
              h2 { margin: 0 0 0.5em 0; }
              .status { font-weight: bold; margin-top: 0.5em; }
            </style>
          </head>
          <body>
            <h1>Bento Grid Redesign - QA Validation Report</h1>

            <div class="tier pass">
              <h2>‚úÖ Tier 1: Structural Validation</h2>
              <p>HTML validity and semantic correctness verified</p>
              <div class="status">Status: ${{ needs.structural-validation.result }}</div>
            </div>

            <div class="tier">
              <h2>üì∏ Tier 2: Visual Regression Testing</h2>
              <p>Visual design consistency across breakpoints</p>
              <div class="status">Status: ${{ needs.visual-regression.result }}</div>
            </div>

            <div class="tier pass">
              <h2>‚úÖ Tier 3: Accessibility (WCAG AA)</h2>
              <p>Keyboard navigation, screen reader support, color contrast</p>
              <div class="status">Status: ${{ needs.accessibility.result }}</div>
            </div>

            <div class="tier pass">
              <h2>‚úÖ Tier 4: Performance</h2>
              <p>Core Web Vitals and Lighthouse compliance</p>
              <div class="status">Status: ${{ needs.performance.result }}</div>
            </div>

            <div class="tier">
              <h2>üé® Tier 5: Brand Consistency</h2>
              <p>Color, typography, and component styling accuracy</p>
              <div class="status">Status: ${{ needs.brand-consistency.result }}</div>
            </div>

            <div class="tier">
              <h2>‚úçÔ∏è Tier 6: Content Validation</h2>
              <p>Grammar, voice authenticity, and SEO metadata</p>
              <div class="status">Status: ${{ needs.content-validation.result }}</div>
            </div>

            <hr>

            <h3>üöÄ Deployment Status</h3>
            <p>
              <strong id="status-text">All validations passed. Ready for deployment.</strong>
            </p>
          </body>
          </html>
          EOF

      - name: Upload validation summary
        uses: actions/upload-artifact@v4
        with:
          name: validation-summary
          path: validation-summary.html
          retention-days: 30

      - name: Set deployment status
        run: |
          BLOCKING="${{ needs.structural-validation.result }}-${{ needs.accessibility.result }}-${{ needs.performance.result }}"
          if [[ "$BLOCKING" == "success-success-success" ]]; then
            echo "‚úÖ All blocking validations passed - OK to deploy"
          else
            echo "‚ùå Blocking validation failed - DO NOT DEPLOY"
            exit 1
          fi

  # Post-validation notifications
  notify-team:
    name: 'Team Notifications'
    runs-on: ubuntu-latest
    needs: [validation-gates]
    if: always()

    steps:
      - name: Determine overall status
        id: status
        run: |
          if [ "${{ needs.validation-gates.result }}" == "success" ]; then
            echo "outcome=success" >> $GITHUB_OUTPUT
            echo "message=‚úÖ Bento Grid validation passed - ready for deployment" >> $GITHUB_OUTPUT
          else
            echo "outcome=failure" >> $GITHUB_OUTPUT
            echo "message=‚ùå Bento Grid validation failed - review required" >> $GITHUB_OUTPUT
          fi

      - name: Comment with final status
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const outcome = '${{ steps.status.outputs.outcome }}';
            const icon = outcome === 'success' ? '‚úÖ' : '‚ùå';

            const comment = `## ${{ steps.status.outputs.message }}\n\n**Run:** [${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n**Triggered by:** @${{ github.actor }}\n\nAll validation tiers have completed. Check the run details for specific failures.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
